
# Macrosilicon MS2107 CVBS to USB converter research

Cheap CVBS-USB converter device contains **MS2107** chip and **AT24C16** EEPROM.

I want to fix some issues in behavior. I read EEPROM with **CH341A** EEPROM programmer and tried to understand internal structure.

Here's my research results:

## Useful resources

8051 command line disassembler, helpful for code analysis
https://github.com/anarcheuz/8051-disassembler.git

ms-tools: research and modifications for MS2106 MS2109 MS2130 chips
https://github.com/BertoldVdb/ms-tools.git

MS2107 datasheet
https://item.szlcsc.com/datasheet/MS2107/44259544.html

## EEPROM data structure

### Format structure

MS2107 EEPROM contains section:
1. [2 bytes] Signature 08 16
2. [2 bytes] Code size N
3. [from 0x04 to 0x30 bytes]  Header data. Configuration parameters and USB devices names
4. [N bytes] Code size 
5. [2 bytes] Header checksum
6. [2 bytes] Code checksum
7. ?? Extended configuration section or code

### Checksums

EEPROM contains 2 checksums, first for code, second for header, but firmware version field is excluded from checksum calculation.

Type of checksums is simple **uint16**, just sum of bytes:

```
header_checksum = sum(2:11) + sum(16:0x30)  # excluded last 4 bytes from first 16-byte line
code_checksum = sum(0x30:0x30+code_size)
```

### Details

| Byte address<br>Offset from start | Len<br>bytes | Default value   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|-----------------------------------|--------------|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 0x00 0x01                         | 2            | 0x08 0x16       | EEPROM image signature                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 0x02 0x03                         | 2            | my case: 0x00E9 | **Program code length** (N), it started from byte 0x30 in EEPROM.<br>Code length can be 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| 0x04 0x05                         | 2            | 0xFFFF          | **USB VID** *(big endian, first byte is hi-byte, second lo-byte)*<br>When default value is specified, chip uses 0x534D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 0x05 0x06                         | 2            | 0xFFFF          | **USB PID** *(big endian, first byte is hi-byte, second lo-byte)*<br>When default value is specified, chip used 0x0021                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 0x08                              | 1            | my case: 0x03   | **Common flags**<br>bit 0 - Patch_Common<br>bit 1 - USB_cmd<br>bit 2 - USB_int<br>bit 3 - Timer_Int<br>bit 4 - VSync_int<br>bit 5 - TVD_int<br>bit 6 - Reserved<br>bit 7 - Reserved                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 0x09                              | 1            | my case: 0xFF   | **Function flag 1**<br>bit 0 - AV port enabled (1-enabled, 0-disabled)<br>bit 1 - SV port enabled (1-enabled, 0-disabled)<br>other bits: 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 0x0A                              | 1            | my case: 0x01   | **Mute pattern (high 4 bits) and Function flag 2 (low 4 bits)**<br><br>   H 4bit             L 4bit<br>[mute partern] [functions 2 enabled]<br><br>**Mute patterns values**<br>0x0 - pure black<br>0x1 - pure blue<br>0x2 - pure green<br>0x3 - pure red<br>0x4 - pure white<br>0x5 - cross hatch<br>0x6 - H ramp<br>0x7 - V ramp<br>0x8 - color bar<br>0x9 - H gray scale<br>0xA - V gray scale<br>0xB - 2nd H gray scale<br>0xC - primary color <br>0xD - interlace black <br>0xE - B&W random<br>0xF - color random<br><br>**Functions 2 flag bits**<br>bit 0 (0x01) - audio enable<br>bit 1 (0x02) - stereo enabled<br>bit 3 (0x04) - save Brightness/Contrast/Saturation/Hue <br>            (4-byte signed int8 config block after checksums) |
| 0x0B                              | 1            |                 | **Default port (high bit) and default TV mode (low 7 bits) selector**<br><br>   H 1bit           L 7bit<br>[default port] [default TV mode]<br><br>**Default port**<br>0 - AV<br>1 - SV  <br><br>**Default TV mode**<br>0x00 - NTSC 358<br>0x01 - NTSC 443 <br>0x02 - PAL<br>0x03 - PAL M<br>0x04 - PAL NC<br>0x05 - SECAM<br>0x06 - PAL 60<br>0x7F - NO SIGNAL                                                                                                                                                                                                                                                                                                                                                                                     |
| 0x0C-0x0F                         | 4            |                 | Firmware version (not used in CRC calculation)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 0x10                              | 1            | 0x0A            | USB Video device name length. 0xFF - no specified name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 0x11-0x1F                         | 15           | "USB Video"     | 'USB Video' device name. Bytes after text contain 0xFF.<br>If no name specified, all field should contain 0xFF                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 0x20                              | 1            | 0x0A            | USB Audio device name length. 0xFF - no specified name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 0x21-0x2F                         | 15           | "USB Audio"     | 'USB Audio' device name. Bytes after text contain 0xFF.<br>If no name specified, all field should contain 0xFF                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 0x30-(0x30+N)                     | N            |                 | Code section                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| (0x30+N)                          | 2            |                 | Code checksum                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| (0x30+N)+2                        | 2            |                 | Header checksum (excludes firmware version field)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| (0x30+N)+4                        | ?            |                 | **Extended configuration section** <br>It contains BCSH values if enabled in Functions 2 flag.<br>Some additional data or code may be included                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |


## Fix checksums after EEPROM modifications

I wrote simple python script for verify and recalculate checksums for *MS2107* EEPROM images, it placed in `eeprom_checksum_tool` directory.

**How to use script `test_fix_checksum.py`**

1. Create file `eeprom.bin` with binary data from EEPROM and place it into directory with `test_fix_checksum.py`
2. Open terminal or cmd, change directory to `{PROJECT_DIR}/eeprom_checksum_tool`
3. Run `python test_fix_checksum.py` without parameters
4. Script verifies checksums, recalculate them and create file `eeprom_modified.bin` file with correct recalculated checksums

## Code section analysis

### TBD

First subroutine (0x30? -> 0x66) probably process USB
I changed `jb xxx` to `nop` instructions - and device was not correctly detected as USB dev

